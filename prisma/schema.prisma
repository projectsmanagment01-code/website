generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Recipe {
  id                  String    @id @default(cuid())
  title               String
  category            String    // DEPRECATED: Keep temporarily for backward compatibility
  categoryId          String?   // NEW: Foreign key to Category model (fixes database error)
  description         String
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  allergyInfo         String
  author              Json
  categoryHref        String?   // DEPRECATED: Will be removed after migration
  categoryLink        String    // DEPRECATED: Will be removed after migration
  completeProcess     Json?
  essIngredientGuide  Json?
  faq                 Json?
  featuredText        String
  heroImage           String
  href                String?
  imageAlt            String?
  images              String[]
  img                 String
  featureImage        String?
  cookingImage        String?
  preparationImage    String?
  finalPresentationImage String?
  ingredientGuide     Json?
  intro               String
  mustKnowTips        String[]
  notes               String[]
  nutritionDisclaimer String
  professionalSecrets String[]
  questions           Json?
  recipeInfo          Json?
  relatedRecipes      Json?
  sections            Json?
  serving             String
  shortDescription    String
  slug                String    @unique
  storage             String
  story               String
  testimonial         String
  timing              Json?
  tools               String[]
  updatedDate         String
  whyYouLove          Json?
  ingredients         Json?
  instructions        Json?
  lastViewedAt        DateTime?
  views               Int       @default(0)
  authorId            String?
  status              String    @default("published")
  
  // SEO enhancement fields (from fix branch)
  lastSEOAnalysis     DateTime?
  seoScore            Float?    // Overall SEO score 0-100
  aiEnhancementsCount Int       @default(0)
  
  // Relations - Combined from both branches
  authorRef           Author?   @relation("AuthorRecipes", fields: [authorId], references: [id])
  categoryRef         Category? @relation("CategoryRecipes", fields: [categoryId], references: [id], onDelete: SetNull)
  
  // Internal linking relations (from final-merge)
  sourceLinkSuggestions InternalLinkSuggestion[] @relation("SourceSuggestions")
  targetLinkSuggestions InternalLinkSuggestion[] @relation("TargetSuggestions")
  orphanPageData        OrphanPage?
  
  // SEO enhancement relations (from fix branch - essential for database errors)
  seoEnhancements     SEOEnhancement[]
  seoMetadata         SEOMetadata[]
  seoImageData        SEOImageData[]
  seoPerformance      SEOPerformance[]
  
  @@index([categoryId])
  @@index([status])
  @@index([createdAt])
}

model Author {
  id         String              @id @default(cuid())
  name       String
  bio        String?
  img        String?
  avatar     String?
  slug       String              @unique
  link       String?
  tags       String[]            @default([]) // Simple category tags (no relation to Category model)
  createdAt  DateTime            @default(now())
  updatedAt  DateTime            @updatedAt
  recipes    Recipe[]            @relation("AuthorRecipes")

  @@map("authors")
}

model Category {
  id          String   @id @default(cuid())
  name        String   // Display name (e.g., "Evening Meals", "Desserts")
  slug        String   @unique // URL-friendly (e.g., "evening-meals", "desserts")
  title       String   // Alternative title field for compatibility
  href        String   // URL/path for category page
  description String?  @db.Text // Full description for category page
  image       String   // Dedicated category image (stored in uploads/categories/)
  alt         String?  // Alt text for image
  sizes       String?  // Image sizes attribute
  icon        String?  // Optional icon identifier for UI
  color       String?  // Brand color for category (hex code)
  order       Int      @default(0) // Display order (lower = shown first)
  isActive    Boolean  @default(true) // Active/inactive toggle
  
  // Admin-specific fields (optional, used by admin components)
  type        String?  // Category type: CUISINE, MEAL_TIME, DIETARY, etc.
  parentId    String?  // Optional parent category for hierarchy
  
  // SEO fields (supporting both naming conventions)
  metaTitle       String?  @db.Text // API uses this
  metaDescription String?  @db.Text // API uses this
  seoTitle        String?  @db.Text // Admin components use this (can be same as metaTitle)
  seoDescription  String?  @db.Text // Admin components use this (can be same as metaDescription)
  
  // Relations
  recipes     Recipe[] @relation("CategoryRecipes")
  parent      Category? @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children    Category[] @relation("CategoryHierarchy")
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([slug])
  @@index([isActive])
  @@index([order])
  @@index([type])
  @@index([parentId])
  @@map("categories")
}

model NavigationItem {
  id            String  @id @default(cuid())
  href          String
  title         String
  iconSrc       String
  iconClassName String
  label         String?
}

model AdminSettings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String?
  updatedAt DateTime @updatedAt
  updatedBy String?
}

model ApiToken {
  id          String    @id @default(cuid())
  name        String
  token       String    @unique
  createdAt   DateTime  @default(now())
  expiresAt   DateTime
  isActive    Boolean   @default(true)
  lastUsedAt  DateTime?
  createdBy   String
  description String?

  @@map("api_tokens")
}

model SEOEnhancementReport {
  id                  String   @id @default(cuid())
  recipeId            String
  recipeTitle         String
  status              String   @default("pending") // pending, processing, success, failed
  seoScore            Int?
  enhancementsCount   Int      @default(0)
  processingTime      Int?     // in seconds
  metadataGenerated   Boolean  @default(false)
  imagesProcessed     Int      @default(0)
  linksGenerated      Int      @default(0)
  schemaEnhanced      Boolean  @default(false)
  errorMessage        String?
  aiResponse          Json?    // Store full AI response
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@map("seo_enhancement_reports")
  @@index([recipeId])
  @@index([status])
  @@index([createdAt])
}

model SEOEnhancement {
  id                String   @id @default(cuid())
  type              String   // 'metadata' | 'image' | 'internal-link' | 'schema' | 'content'
  status            String   @default("pending") // 'pending' | 'approved' | 'rejected' | 'applied'
  confidence        Float    // 0-1 confidence score from AI
  originalContent   String?  // Original content being replaced
  suggestedContent  String   // AI-generated content
  reasoning         String   // Why this change is suggested
  keywords          String[] // Related keywords
  estimatedImpact   String   // 'low' | 'medium' | 'high'
  
  // Relations
  recipeId          String?
  recipe            Recipe?  @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  
  // Admin management
  reviewedBy        String?  // Admin who reviewed
  reviewedAt        DateTime?
  appliedBy         String?  // Admin who applied
  appliedAt         DateTime?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("seo_enhancements")
}

model SEOMetadata {
  id                String   @id @default(cuid())
  
  // Page identification
  pageType          String   // 'recipe' | 'category' | 'author' | 'static'
  pageId            String   // ID of the specific page
  slug              String   @unique
  
  // AI-generated metadata
  aiTitle           String?
  aiDescription     String?
  aiKeywords        String[]
  aiOgTitle         String?
  aiOgDescription   String?
  aiTwitterTitle    String?
  aiTwitterDescription String?
  
  // Current live metadata
  currentTitle      String?
  currentDescription String?
  currentKeywords   String[]
  
  // Performance tracking
  generatedAt       DateTime @default(now())
  lastApplied       DateTime?
  performanceScore  Float?   // CTR, impressions, etc.
  
  // Relations
  recipeId          String?
  recipe            Recipe?  @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("seo_metadata")
}

model SEOImageData {
  id                String   @id @default(cuid())
  
  // Image identification
  imageUrl          String   @unique
  imageHash         String?  // For detecting duplicates
  
  // AI-generated content
  aiAltText         String?
  aiCaption         String?
  aiTitle           String?
  aiStructuredData  Json?
  
  // Current content
  currentAltText    String?
  currentCaption    String?
  currentTitle      String?
  
  // Context
  pageType          String   // Where this image appears
  pageId            String
  imageContext      String   // 'hero' | 'ingredient' | 'step' | 'final-result'
  
  // Performance
  generatedAt       DateTime @default(now())
  lastApplied       DateTime?
  
  // Relations
  recipeId          String?
  recipe            Recipe?  @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("seo_image_data")
}

model SEOInternalLink {
  id                String   @id @default(cuid())
  
  // Source page
  sourcePage        String   // URL where link should be added
  sourcePageType    String   // 'recipe' | 'category' | 'static'
  sourcePageId      String
  
  // Target page
  targetPage        String   // URL being linked to
  targetPageType    String
  targetPageId      String
  targetPageTitle   String
  
  // Link details
  anchorText        String
  contextBefore     String
  contextAfter      String
  linkType          String   // 'related-recipe' | 'category' | 'ingredient' | 'technique'
  relevanceScore    Float
  
  // Status
  status            String   @default("pending") // 'pending' | 'approved' | 'rejected' | 'applied'
  appliedAt         DateTime?
  
  // Performance tracking
  clickThrough      Int      @default(0)
  impressions       Int      @default(0)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("seo_internal_links")
}

model SEOPerformance {
  id                String   @id @default(cuid())
  
  // Page identification
  pageUrl           String
  pageType          String
  pageId            String
  
  // SEO metrics
  organicImpressions Int     @default(0)
  organicClicks     Int     @default(0)
  organicCTR        Float   @default(0)
  averagePosition   Float   @default(0)
  
  // AI enhancement impact
  beforeEnhancement Json?   // Metrics before AI changes
  afterEnhancement  Json?   // Metrics after AI changes
  improvementScore  Float?  // Calculated improvement
  
  // Time period
  dateFrom          DateTime
  dateTo            DateTime
  
  // Relations
  recipeId          String?
  recipe            Recipe?  @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([pageUrl, dateFrom, dateTo])
  @@map("seo_performance")
}

// Store site configuration (hero content, site info, social links)
// This prevents config from being overwritten on deployments
model SiteConfig {
  id        String   @id @default(cuid())
  key       String   @unique // "hero", "site", "social_links"
  data      Json     // Store the entire config object as JSON
  updatedAt DateTime @updatedAt
  updatedBy String?  // Track who made changes
  
  @@map("site_config")
}

// Store all page content (privacy, terms, about, contact, faq, disclaimer, cookies, etc.)
// This prevents content from being overwritten on deployments
model PageContent {
  id              String   @id @default(cuid())
  page            String   @unique // "privacy", "terms", "about", "contact", "faq", "disclaimer", "cookies"
  title           String?  @db.Text
  heroTitle       String?  @db.Text
  heroDescription String?  @db.Text
  heroIntro       String?  @db.Text
  content         String?  @db.Text // HTML or JSON content
  metaTitle       String?  @db.Text
  metaDescription String?  @db.Text
  data            Json?    // Additional structured data (e.g., contact cards, FAQ items)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  updatedBy       String?  // Track who made changes
  
  @@map("page_content")
}

// Media Management System - Tracks all uploaded files with metadata
model Media {
  id            String    @id @default(cuid())
  filename      String    // Sanitized filename on disk (e.g., "chocolate-cake.webp")
  originalName  String    // Original upload filename (e.g., "Chocolate Cake.jpg")
  path          String    // Relative path from uploads root (e.g., "recipes/chocolate-cake.webp")
  url           String    // Public URL to access file (e.g., "/uploads/recipes/chocolate-cake.webp")
  category      String    // File category: recipes, authors, general, categories, ingredients
  mimeType      String    // MIME type (e.g., "image/webp", "image/jpeg")
  size          Int       // File size in bytes
  width         Int?      // Image width in pixels (null for non-images)
  height        Int?      // Image height in pixels (null for non-images)
  thumbnailUrl  String?   // URL to thumbnail version (e.g., "/uploads/recipes/thumb_chocolate-cake.webp")
  
  // Metadata
  alt           String?   // Alt text for accessibility
  caption       String?   // Image caption
  tags          String[]  @default([]) // Searchable tags
  
  // Relationships
  recipeId      String?   // Optional: Link to recipe this image belongs to
  authorId      String?   // Optional: Link to author (for author avatars)
  categoryId    String?   // Optional: Link to category (for category images)
  
  // Audit fields
  uploadedBy    String?   // User ID or admin who uploaded
  uploadedAt    DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Soft delete
  deletedAt     DateTime? // Soft delete timestamp
  
  // Performance indexes
  @@index([category])
  @@index([filename])
  @@index([uploadedAt])
  @@index([recipeId])
  @@index([authorId])
  @@index([categoryId])
  @@unique([category, filename]) // Prevent duplicate filenames within same category
  
  @@map("media")
}

// ==========================================
// INTERNAL LINKING SYSTEM
// ==========================================

// Internal Link Suggestion - Stores link opportunities before they are applied
model InternalLinkSuggestion {
  id              String    @id @default(cuid())
  sourceRecipeId  String
  targetRecipeId  String
  anchorText      String    // The keyword/phrase to be linked
  fieldName       String    // Which field: 'intro', 'story', 'description', 'instructions'
  sentenceContext String    @db.Text // Full sentence containing the keyword for preview
  position        Int       // Character position in the field
  relevanceScore  Float     // 0-100 score indicating link quality
  status          String    @default("pending") // pending, applied
  appliedAt       DateTime?
  appliedBy       String?   // Admin user who applied it
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  sourceRecipe    Recipe    @relation("SourceSuggestions", fields: [sourceRecipeId], references: [id], onDelete: Cascade)
  targetRecipe    Recipe    @relation("TargetSuggestions", fields: [targetRecipeId], references: [id], onDelete: Cascade)
  
  @@index([sourceRecipeId])
  @@index([targetRecipeId])
  @@index([status])
  @@index([relevanceScore])
  @@map("internal_link_suggestions")
}

// Orphan Page Detection - Tracks recipes with insufficient internal links
model OrphanPage {
  id              String    @id @default(cuid())
  recipeId        String    @unique
  incomingLinks   Int       @default(0)
  outgoingLinks   Int       @default(0)
  isOrphan        Boolean   @default(false) // True if incoming links < threshold
  priority        Int       @default(0) // Numeric priority score
  lastChecked     DateTime  @default(now())
  suggestions     Json?     // Suggested keywords to generate links
  
  // Relations
  recipe          Recipe    @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  
  @@index([isOrphan])
  @@index([priority])
  @@index([lastChecked])
  @@map("orphan_pages")
}

// ==========================================
// AD MANAGEMENT SYSTEM
// ==========================================

enum AdType {
  GOOGLE_ADSENSE
  CUSTOM_HTML
  IMAGE
  SCRIPT
}

enum AdPlacement {
  recipe_sidebar_top
  recipe_sidebar_middle
  recipe_sidebar_bottom
  recipe_below_image
  recipe_in_content_1
  recipe_in_content_2
  recipe_in_content_3
  recipe_card_top
  recipe_card_bottom
  home_hero_below
  category_top
  search_top
  article_sidebar
  article_in_content
}

model Ad {
  id               String      @id @default(cuid())
  name             String
  type             AdType
  placement        AdPlacement
  content          String      @db.Text // Ad code/HTML/Script
  imageUrl         String?     // For IMAGE type
  linkUrl          String?     // For IMAGE type
  width            Int?        // Ad dimensions
  height           Int?
  priority         Int         @default(0) // Higher priority shows first
  isActive         Boolean     @default(true)
  startDate        DateTime?   // Optional scheduling
  endDate          DateTime?
  clickCount       Int         @default(0)
  impressionCount  Int         @default(0)
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  createdBy        String?

  @@index([placement, isActive, priority])
}
