generator client {
  provider = "prisma-client-js"
  // Note: tracing and metrics are now built-in features (no longer preview features)
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // Optional: Use directUrl for migrations if using connection pooler
  // directUrl = env("DATABASE_URL_DIRECT")
}

model Recipe {
  id                  String    @id @default(cuid())
  title               String
  category            String    // DEPRECATED: Keep temporarily for backward compatibility
  categoryId          String?   // NEW: Foreign key to Category model
  description         String
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  allergyInfo         String?   // Made optional
  author              Json
  categoryHref        String?   // DEPRECATED: Will be removed after migration
  categoryLink        String    // DEPRECATED: Will be removed after migration
  completeProcess     Json?
  essIngredientGuide  Json?
  faq                 Json?
  featuredText        String
  heroImage           String
  href                String?
  imageAlt            String?
  images              String[]
  img                 String
  featureImage        String?
  cookingImage        String?
  preparationImage    String?
  finalPresentationImage String?
  ingredientGuide     Json?
  intro               String?   // Made optional
  mustKnowTips        String[]
  notes               String[]
  nutritionDisclaimer String?   // Made optional
  professionalSecrets String[]
  questions           Json?
  recipeInfo          Json?
  relatedRecipes      Json?
  sections            Json?
  serving             String?   // Made optional
  shortDescription    String
  slug                String    @unique
  storage             String?   // Made optional
  story               String?   // Made optional
  testimonial         String?   // Made optional
  timing              Json?
  tools               String[]
  updatedDate         String
  whyYouLove          Json?
  ingredients         Json?
  instructions        Json?
  lastViewedAt        DateTime?
  views               Int       @default(0)
  authorId            String?
  status              String    @default("published")
  
  // SEO Enhancement Fields
  videoUrl            String?   // YouTube video URL for recipe
  videoDuration       String?   // ISO 8601 duration e.g., "PT5M30S"
  nutrition           Json?     // Nutrition data for rich snippets
  aggregateRating     Float?    // Average rating (1-5)
  reviewCount         Int?      // Number of reviews
  keywords            String[]  @default([]) // Additional SEO keywords
  
  // Advanced Content Fields (SEO & UX Boosters)
  tasteProfile        Json?     // sweet, salty, spicy, sour, umami, overall
  textureProfile      Json?     // outside, inside, bite, overall
  recipeOrigin        String?   // Cultural/historical background
  variations          Json?     // Array of {title, description}
  substitutions       Json?     // Array of {ingredient, substitute, note}
  dietaryAdaptations  Json?     // Array of {diet, howToAdapt}
  pairings            String[]  @default([]) // Drink, side, dessert pairings
  shoppingList        String[]  @default([]) // Simplified ingredient list
  makeAhead           String?   // Prep-ahead instructions
  leftovers           String?   // Reheat/reuse instructions
  equipmentNotes      String[]  @default([]) // Notes about equipment
  ingredientPrep      String[]  @default([]) // Small prep steps
  temperatureNotes    Json?     // stovetopHeatLevel, ovenTemperature, safeInternalTemp
  timeline            Json?     // Array of {time, action}
  commonMistakes      String[]  @default([]) // SEO boost - what to avoid
  flavorBoosters      String[]  @default([]) // Chef tips for extra flavor
  specialNotes        String[]  @default([]) // Uncommon details
  difficultyReasoning String?   // Why easy/medium/hard
  servingSuggestions  String[]  @default([]) // Structured serving ideas
  seasonality         String?   // Best season to enjoy
  
  // Relations
  authorRef           Author?   @relation("AuthorRecipes", fields: [authorId], references: [id])
  categoryRef         Category? @relation("CategoryRecipes", fields: [categoryId], references: [id], onDelete: SetNull)
  
  @@index([categoryId])
  @@index([status])
  @@index([createdAt])
}

model Author {
  id         String              @id @default(cuid())
  name       String
  bio        String?
  img        String?
  avatar     String?
  slug       String              @unique
  link       String?
  tags       String[]            @default([]) // Simple category tags (no relation to Category model)
  createdAt  DateTime            @default(now())
  updatedAt  DateTime            @updatedAt
  recipes    Recipe[]            @relation("AuthorRecipes")
  articles   Article[]           @relation("AuthorArticles")

  @@map("authors")
}

model Category {
  id          String   @id @default(cuid())
  name        String   // Display name (e.g., "Evening Meals", "Desserts")
  slug        String   @unique // URL-friendly (e.g., "evening-meals", "desserts")
  description String?  @db.Text // Full description for category page
  image       String   // Dedicated category image (stored in uploads/categories/)
  icon        String?  // Optional icon identifier for UI
  color       String?  // Brand color for category (hex code)
  order       Int      @default(0) // Display order (lower = shown first)
  isActive    Boolean  @default(true) // Active/inactive toggle
  
  // SEO fields
  metaTitle       String?  @db.Text
  metaDescription String?  @db.Text
  
  // Relations
  recipes     Recipe[]   @relation("CategoryRecipes")
  articles    Article[]  @relation("CategoryArticles")
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([slug])
  @@index([isActive])
  @@index([order])
  @@map("categories")
}

// Article System - Flexible HTML-based content for viral articles/blog posts
model Article {
  id                  String    @id @default(cuid())
  
  // Core Content
  title               String    @db.Text              // Article title
  slug                String    @unique               // URL-friendly slug
  content             String    @db.Text              // FREE HTML content (H1, H2, images, quotes, etc.)
  excerpt             String?   @db.Text              // Short preview/summary
  
  // Media
  featuredImage       String?                         // Hero/featured image URL
  featuredImageAlt    String?                         // Alt text for featured image
  
  // Classification
  categoryId          String?                         // Foreign key to Category
  tags                String[]  @default([])          // Topic tags for filtering/SEO
  
  // Author
  authorId            String?                         // Foreign key to Author
  
  // SEO Fields
  metaTitle           String?   @db.Text              // Custom meta title (defaults to title)
  metaDescription     String?   @db.Text              // Meta description for search engines
  focusKeyword        String?                         // Primary SEO keyword
  canonicalUrl        String?                         // Canonical URL if needed
  
  // Social Sharing (Open Graph / Twitter)
  ogImage             String?                         // Open Graph image (1200x630)
  ogTitle             String?   @db.Text              // Social share title
  ogDescription       String?   @db.Text              // Social share description
  
  // Stats & Engagement
  readingTime         Int?                            // Estimated minutes (auto-calculated)
  views               Int       @default(0)           // View counter
  
  // Publishing Control
  status              String    @default("draft")     // draft, published, archived
  publishedAt         DateTime?                       // Publication date/time
  isFeatured          Boolean   @default(false)       // Featured article flag
  
  // Timestamps
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  // Relations
  authorRef           Author?   @relation("AuthorArticles", fields: [authorId], references: [id])
  categoryRef         Category? @relation("CategoryArticles", fields: [categoryId], references: [id], onDelete: SetNull)
  
  @@index([slug])
  @@index([status])
  @@index([publishedAt])
  @@index([categoryId])
  @@index([authorId])
  @@index([isFeatured])
  @@map("articles")
}

model NavigationItem {
  id            String  @id @default(cuid())
  href          String
  title         String
  iconSrc       String
  iconClassName String
  label         String?
}

model AdminSettings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String?
  updatedAt DateTime @updatedAt
  updatedBy String?
}

// Store site configuration (hero content, site info, social links)
// This prevents config from being overwritten on deployments
model SiteConfig {
  id        String   @id @default(cuid())
  key       String   @unique // "hero", "site", "social_links"
  data      Json     // Store the entire config object as JSON
  updatedAt DateTime @updatedAt
  updatedBy String?  // Track who made changes
  
  @@map("site_config")
}

// Store all page content (privacy, terms, about, contact, faq, disclaimer, cookies, etc.)
// This prevents content from being overwritten on deployments
model PageContent {
  id              String   @id @default(cuid())
  page            String   @unique // "privacy", "terms", "about", "contact", "faq", "disclaimer", "cookies"
  title           String?  @db.Text
  heroTitle       String?  @db.Text
  heroDescription String?  @db.Text
  heroIntro       String?  @db.Text
  content         String?  @db.Text // HTML or JSON content
  metaTitle       String?  @db.Text
  metaDescription String?  @db.Text
  data            Json?    // Additional structured data (e.g., contact cards, FAQ items)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  updatedBy       String?  // Track who made changes
  
  @@map("page_content")
}

model ApiToken {
  id          String    @id @default(cuid())
  name        String
  token       String    @unique
  createdAt   DateTime  @default(now())
  expiresAt   DateTime
  isActive    Boolean   @default(true)
  lastUsedAt  DateTime?
  createdBy   String
  description String?

  @@map("api_tokens")
}

model SEOEnhancementReport {
  id                  String   @id @default(cuid())
  recipeId            String
  recipeTitle         String
  status              String   @default("pending") // pending, processing, success, failed
  seoScore            Int?
  enhancementsCount   Int      @default(0)
  processingTime      Int?     // in seconds
  metadataGenerated   Boolean  @default(false)
  imagesProcessed     Int      @default(0)
  linksGenerated      Int      @default(0)
  schemaEnhanced      Boolean  @default(false)
  errorMessage        String?
  aiResponse          Json?    // Store full AI response
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@map("seo_enhancement_reports")
  @@index([recipeId])
  @@index([status])
  @@index([createdAt])
}

// Media Management System - Tracks all uploaded files with metadata
model Media {
  id            String    @id @default(cuid())
  filename      String    // Sanitized filename on disk (e.g., "chocolate-cake.webp")
  originalName  String    // Original upload filename (e.g., "Chocolate Cake.jpg")
  path          String    // Relative path from uploads root (e.g., "recipes/chocolate-cake.webp")
  url           String    // Public URL to access file (e.g., "/uploads/recipes/chocolate-cake.webp")
  category      String    // File category: recipes, authors, general, categories, ingredients
  mimeType      String    // MIME type (e.g., "image/webp", "image/jpeg")
  size          Int       // File size in bytes
  width         Int?      // Image width in pixels (null for non-images)
  height        Int?      // Image height in pixels (null for non-images)
  thumbnailUrl  String?   // URL to thumbnail version (e.g., "/uploads/recipes/thumb_chocolate-cake.webp")
  
  // Metadata
  alt           String?   // Alt text for accessibility
  caption       String?   // Image caption
  tags          String[]  @default([]) // Searchable tags
  
  // Relationships
  recipeId      String?   // Optional: Link to recipe this image belongs to
  authorId      String?   // Optional: Link to author (for author avatars)
  categoryId    String?   // Optional: Link to category (for category images)
  
  // Audit fields
  uploadedBy    String?   // User ID or admin who uploaded
  uploadedAt    DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Soft delete
  deletedAt     DateTime? // Soft delete timestamp
  
  // Performance indexes
  @@index([category])
  @@index([filename])
  @@index([uploadedAt])
  @@index([recipeId])
  @@index([authorId])
  @@index([categoryId])
  @@unique([category, filename]) // Prevent duplicate filenames within same category
  
  @@map("media")
}

// Ad Management System - Full-featured ad placement
model Ad {
  id          String    @id @default(cuid())
  name        String    // Internal name for identification
  description String?   // Admin notes
  
  // Ad Type & Provider
  adType      String    @default("adsense") // adsense, custom, affiliate, house
  provider    String?   // google, amazon, custom
  
  // AdSense/GPT specific fields
  slotId      String?   // AdSense slot ID (e.g., "1234567890")
  publisherId String?   // AdSense publisher ID (e.g., "ca-pub-XXXXXXXX")
  adFormat    String?   @default("auto") // auto, horizontal, vertical, rectangle
  
  // Placement Configuration
  placement   String    // before-hero, after-hero, in-content, after-ingredients, after-instructions, sidebar-top, sidebar-sticky, footer, between-recipes
  position    Int       @default(0) // Order within same placement
  
  // Size Configuration
  sizes       String[]  @default([]) // ["728x90", "300x250", "responsive"]
  responsive  Boolean   @default(true) // Use responsive sizing
  minWidth    Int?      // Minimum viewport width to show ad
  maxWidth    Int?      // Maximum viewport width to show ad
  
  // Targeting
  targetPages String[]  @default([]) // Empty = all pages, ["recipe", "category", "home"]
  targetCategories String[] @default([]) // Empty = all categories
  excludePages String[] @default([]) // Pages to exclude
  
  // Content (for custom/affiliate ads)
  adCode      String?   @db.Text // Custom HTML/JS code
  imageUrl    String?   // For image-based ads
  linkUrl     String?   // Click destination
  altText     String?   // Image alt text
  
  // Performance & Control
  isActive    Boolean   @default(true)
  priority    Int       @default(0) // Higher = more important
  lazyLoad    Boolean   @default(true) // Use Intersection Observer
  lazyOffset  String?   @default("200px") // Load when within X of viewport
  
  // Scheduling
  startDate   DateTime? // Start showing ad
  endDate     DateTime? // Stop showing ad
  
  // Stats (optional tracking)
  impressions Int       @default(0)
  clicks      Int       @default(0)
  
  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdBy   String?   // Admin who created

  @@map("ads")
  @@index([placement])
  @@index([isActive])
  @@index([adType])
}

// Internal Link Suggestions for SEO
model InternalLinkSuggestion {
  id            String    @id @default(cuid())
  sourceRecipeId String
  targetRecipeId String?
  sourceTitle   String?
  targetTitle   String?
  suggestedText String?
  linkType      String?   // "related", "similar", "ingredient", "author"
  status        String    @default("pending") // pending, approved, rejected, applied
  confidence    Float?    // 0-1 confidence score
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("internal_link_suggestions")
  @@index([sourceRecipeId])
  @@index([status])
}

// Hero Slides for Homepage
model HeroSlide {
  id              String    @id @default(cuid())
  title           String    @db.Text
  description     String    @db.Text
  buttonText      String
  buttonLink      String
  backgroundImage String    // URL or path to background image
  order           Int       @default(0) // Display order (lower = shown first)
  isActive        Boolean   @default(true) // Active/inactive toggle
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  updatedBy       String?   // Track who made changes

  @@map("hero_slides")
  @@index([order])
  @@index([isActive])
}

// Newsletter Subscribers
model Subscriber {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  status        String    @default("active") // active, unsubscribed
  subscribedAt  DateTime  @default(now())
  unsubscribedAt DateTime?
  source        String?   // Where they subscribed from (homepage, recipe-page, etc.)
  
  @@map("subscribers")
  @@index([email])
  @@index([status])
  @@index([subscribedAt])
}

model AnalyticsVisitor {
  id         String   @id @default(cuid())
  ip         String
  country    String   @default("Unknown")
  city       String   @default("Unknown")
  userAgent  String   @default("Unknown")
  page       String
  latitude   Float    @default(0)
  longitude  Float    @default(0)
  visitedAt  DateTime @default(now())
  
  // Phase 1: Traffic Sources & Device Analytics
  referrer    String?   @db.VarChar(500)
  sourceType  String?   @default("direct") // organic, social, direct, referral, email
  deviceType  String?   @default("desktop") // mobile, desktop, tablet
  browser     String?   @default("unknown")
  os          String?   @default("unknown")
  sessionId   String?   // For grouping page views into sessions
  duration    Int       @default(0) // Time on page in seconds
  scrollDepth Int       @default(0) // Max scroll percentage (0-100)
  
  // UTM Parameters
  utmSource   String?
  utmMedium   String?
  utmCampaign String?

  @@map("analytics_visitors")
  @@unique([ip, page, visitedAt])
  @@index([country])
  @@index([visitedAt])
  @@index([page])
  @@index([sessionId])
  @@index([sourceType])
  @@index([deviceType])
}

model SearchQuery {
  id            String   @id @default(cuid())
  query         String
  resultsCount  Int      @default(0)
  clickedResult Boolean  @default(false)
  sessionId     String?
  visitorId     String?
  searchedAt    DateTime @default(now())

  @@map("search_queries")
  @@index([searchedAt])
  @@index([query])
}

model ConversionEvent {
  id        String   @id @default(cuid())
  eventType String   // 'subscribe', 'print', 'share', 'save', 'copy_ingredients'
  recipeId  String?
  visitorId String?
  sessionId String?
  meta      Json?    // Extra data (e.g., which social platform)
  createdAt DateTime @default(now())

  @@map("conversion_events")
  @@index([eventType])
  @@index([createdAt])
  @@index([sessionId])
  @@index([visitorId])
}
